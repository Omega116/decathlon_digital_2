{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/user/Desktop/nuit/muscle-selector/app/api/gemini-feedback/route.ts"],"sourcesContent":["export const runtime = \"nodejs\";\n\ninterface GenerateRequest {\n  exercise: string;\n  angles: Record<string, number>;\n  idealAngles: Record<string, [number, number]>;\n  previousFeedback?: string;\n  referenceImagePath?: string;\n  currentFrameDataUrl?: string;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const apiKey = process.env.GOOGLE_API_KEY;\n    if (!apiKey) {\n      return new Response(\"Missing GOOGLE_API_KEY\", { status: 500 });\n    }\n\n    const body = (await req.json()) as GenerateRequest;\n    const {\n      exercise,\n      angles,\n      idealAngles,\n      previousFeedback,\n      referenceImagePath,\n      currentFrameDataUrl,\n    } = body;\n\n    const anglesText = Object.entries(angles)\n      .map(([joint, angle]) => `${joint}: ${angle}°`)\n      .join(\"\\n\");\n\n    const idealText = Object.entries(idealAngles)\n      .map(([joint, range]) => `${joint}: ${range[0]}°-${range[1]}°`)\n      .join(\"\\n\");\n\n    const prompt = `You are an expert fitness coach analyzing a ${exercise} exercise in real-time.\n\nATTACHED IMAGES:\n1) User's current frame (live capture)\n2) Reference correct form image\n\nCURRENT BODY ANGLES:\\n${anglesText}\n\nIDEAL ANGLE RANGES FOR ${exercise.toUpperCase()}:\\n${idealText}\n\nPREVIOUS FEEDBACK: ${previousFeedback || \"None\"}\n\nINSTRUCTIONS:\n- Compare the user's posture to the attached reference image (treat it as the correct form) and to the ideal angle ranges.\n- If form accuracy is 95%+ respond with ONLY: \"✓ PERFECT! Your form is excellent. Keep it up!\".\n- Otherwise, give 2-3 specific, actionable corrections focusing on the biggest issues.\n- Be encouraging but direct. Keep under 100 words.`;\n\n    // Build multimodal parts: optional current frame + reference image + text\n    type Part =\n      | { text: string }\n      | { inlineData: { mimeType: string; data: string } };\n    const parts: Part[] = [];\n\n    // Attach current frame from data URL if provided\n    if (currentFrameDataUrl && currentFrameDataUrl.startsWith(\"data:\")) {\n      try {\n        const commaIdx = currentFrameDataUrl.indexOf(\",\");\n        if (commaIdx > 0) {\n          const meta = currentFrameDataUrl.substring(0, commaIdx);\n          const dataB64 = currentFrameDataUrl.substring(commaIdx + 1);\n          const mimeMatch = meta.match(/^data:([^;]+);base64$/);\n          const mimeType = mimeMatch?.[1] || \"image/jpeg\";\n          parts.push({ inlineData: { mimeType, data: dataB64 } });\n        }\n      } catch {}\n    }\n\n    // Attach reference image from /public if provided\n    if (referenceImagePath) {\n      try {\n        const { promises: fsp } = await import(\"fs\");\n        const pathMod = await import(\"path\");\n        const normalized = pathMod.default.normalize(\n          referenceImagePath.replace(/^\\/+/, \"\")\n        );\n        const publicRoot = pathMod.default.join(process.cwd(), \"public\");\n        let absPath = pathMod.default.join(publicRoot, normalized);\n        // Basic containment check\n        if (absPath.startsWith(publicRoot)) {\n          let usePath = absPath;\n          let useExt = pathMod.default.extname(usePath).toLowerCase();\n          if (useExt === \".gif\") {\n            // Try to find a non-GIF sibling with same basename\n            const base = usePath.slice(0, -useExt.length);\n            const candidates = [\".jpg\", \".jpeg\", \".png\", \".webp\"];\n            for (const c of candidates) {\n              const p = base + c;\n              try {\n                await fsp.stat(p);\n                usePath = p;\n                useExt = c;\n                break;\n              } catch {}\n            }\n          }\n          if (useExt !== \".gif\") {\n            const buf = await fsp.readFile(usePath);\n            const b64 = buf.toString(\"base64\");\n            const mimeType =\n              useExt === \".png\"\n                ? \"image/png\"\n                : useExt === \".jpg\" || useExt === \".jpeg\"\n                ? \"image/jpeg\"\n                : useExt === \".webp\"\n                ? \"image/webp\"\n                : \"application/octet-stream\";\n            parts.push({ inlineData: { mimeType, data: b64 } });\n          }\n          // If still GIF (no sibling found), skip attaching to avoid 400\n        }\n      } catch {\n        // ignore image attach failures; proceed with text-only prompt\n      }\n    }\n\n    parts.push({ text: prompt });\n\n    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;\n    const res = await fetch(url, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ contents: [{ role: \"user\", parts }] }),\n    });\n\n    if (!res.ok) {\n      const text = await res.text();\n      return Response.json(\n        { error: `Gemini API error: ${res.status} ${text}` },\n        { status: 500 }\n      );\n    }\n\n    const data = (await res.json()) as {\n      candidates?: Array<{ content?: { parts?: Array<{ text?: string }> } }>;\n    };\n    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || \"\";\n\n    return Response.json({ text });\n  } catch (err: unknown) {\n    console.error(\"gemini-feedback error\", err);\n    return Response.json({ error: \"Failed to get feedback\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}